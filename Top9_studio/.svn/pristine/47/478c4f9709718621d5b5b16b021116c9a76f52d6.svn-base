package com.zeustel.top9.adapters;

import android.content.Context;
import android.view.View;
import android.widget.ImageView;
import android.widget.TextView;

import com.google.gson.Gson;
import com.loopj.android.http.AsyncHttpResponseHandler;
import com.zeustel.top9.R;
import com.zeustel.top9.bean.SubUserInfo;
import com.zeustel.top9.bean.community.Comment;
import com.zeustel.top9.bean.community.Level;
import com.zeustel.top9.result.Result;
import com.zeustel.top9.utils.Constants;
import com.zeustel.top9.utils.Tools;
import com.zeustel.top9.utils.operate.DataUser;

import org.apache.http.Header;

/**
 * @author NiuLei
 * @email niulei@zeustel.com
 * @date 2015/11/10 13:51
 */
public class HolderComment extends OverallRecyclerHolder<Comment> {

    private ImageView comment_icon;
    private TextView comment_level;
    private TextView comment_name;
    private TextView comment_time;
    private TextView comment_content;
    private TextView comment_goodCount;
    private TextView comment_replyCount;
    private View animGood;
    private Gson gson = new Gson();

    public HolderComment(Context context, View itemView) {
        super(context, itemView);
    }

    @Override
    protected void initItemView(View itemView) {
        comment_icon = (ImageView) itemView.findViewById(R.id.comment_icon);
        comment_level = (TextView) itemView.findViewById(R.id.comment_level);
        comment_name = (TextView) itemView.findViewById(R.id.comment_name);
        comment_time = (TextView) itemView.findViewById(R.id.comment_time);
        comment_content = (TextView) itemView.findViewById(R.id.comment_content);
        comment_goodCount = (TextView) itemView.findViewById(R.id.comment_goodCount);
        comment_replyCount = (TextView) itemView.findViewById(R.id.comment_replyCount);
        animGood = itemView.findViewById(R.id.animGood);
        comment_icon.setOnClickListener(this);
        comment_goodCount.setOnClickListener(this);
        comment_replyCount.setOnClickListener(this);

    }

    @Override
    public void set(final OverallRecyclerAdapter<Comment> adapter, int position) {
        animGood.setVisibility(View.INVISIBLE);
        final Comment item = adapter.getItem(position);
        if (item != null) {
            SubUserInfo commentUser = item.getPublishUser();
            if (commentUser != null) {
                getImageLoader().displayImage(Constants.TEST_IMG + commentUser.getIcon(), comment_icon, Tools.options);
                Level level = item.getLevel();
                if (Level.BEST.equals(level)) {
                    comment_level.setVisibility(View.VISIBLE);
                } else {
                    comment_level.setVisibility(View.INVISIBLE);
                }
                comment_name.setText(commentUser.getNickName());
                //                if (Mutual.ContentType.AUDIO != item.getContentType()) {
                comment_content.setText(item.getContent().getMsg());
                //                } else {
                //
                //                }
                try {
                    comment_goodCount.setText(String.valueOf(item.getGoodCount()));
                } catch (Exception e) {
                    e.printStackTrace();
                    comment_goodCount.setText("0");
                }
                comment_goodCount.setSelected(item.isGooded());
                try {
                    comment_replyCount.setText(String.valueOf(item.getReplyCount()));
                } catch (Exception e) {
                    e.printStackTrace();
                    comment_replyCount.setText("0");
                }
            }
            if (!item.isGooded()) {
                DataUser.checkGoodState(item.getId(), new AsyncHttpResponseHandler() {
                    @Override
                    public void onSuccess(int i, Header[] headers, byte[] bytes) {
                        if (bytes != null) {
                            Result result = gson.fromJson(new String(bytes), Result.class);
                            if (result != null) {
                                if (result.getError() == 10017/*已经点赞*/) {
                                    comment_goodCount.setSelected(true);
                                }
                            }
                        }
                    }

                    @Override
                    public void onFailure(int i, Header[] headers, byte[] bytes, Throwable throwable) {

                    }
                });
            }
        }
    }

    @Override
    public void onClick(View v) {
        super.onClick(v);
        if (getOnElementClickListener() != null) {
            switch (v.getId()) {
                case R.id.comment_icon:
                    getOnElementClickListener().onElementClick(getAdapterPosition(), "icon");
                    break;
                case R.id.comment_goodCount:
                    getOnElementClickListener().onElementClick(getAdapterPosition(), "good");
                    break;
                case R.id.comment_replyCount:
                    getOnElementClickListener().onElementClick(getAdapterPosition(), "reply");
                    break;
            }
        }
    }

    public void goodChange(int position) {
        if (getAdapterPosition() == position) {
            Tools.startGoodOne(getContext(), animGood);
        }
    }
}
